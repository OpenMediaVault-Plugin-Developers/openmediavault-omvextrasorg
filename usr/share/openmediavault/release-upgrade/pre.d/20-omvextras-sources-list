#!/bin/sh

export LANG=C
export LC_ALL=C

armbian="/etc/apt/sources.list.d/armbian.list"
docker="/etc/apt/sources.list.d/omvdocker.sources"
list="/etc/apt/sources.list.d/omvextras.sources"
pref="/etc/apt/preferences.d/omvextras.pref"
raspi="/etc/apt/sources.list.d/raspi.list"
pve="/etc/apt/sources.list.d/pvekernel.list"

if [ -f "${armbian}" ]; then
  echo "Fixing Armbian repo ..."
  sed -i "s/bookworm/trixie/g" ${armbian}
fi

if [ -f "${docker}" ]; then
  echo "Fixing Docker repo ..."
  sed -i "s/bookworm/trixie/g" ${docker}
fi

if [ -f "${list}" ]; then
  echo "Fixing omv-extras repos ..."
  sed -i "s/bookworm/trixie/g" ${list}
  sed -i "s/sandworm/synchrony/g" ${list}
fi

if [ -f "${pref}" ]; then
  echo "Fixing omv-extras pinnings ..."
  sed -i "s/bookworm/trixie/g" ${pref}
fi

if [ -f "${pve}" ]; then
  distro="trixie"
  pvekey="/usr/share/keyrings/proxmox-archive-keyring.gpg"
  pverepo="/etc/apt/sources.list.d/pvekernel.sources"
  repourl=${OMV_PROXMOX_APT_REPOSITORY_URL:-"http://download.proxmox.com/debian/pve"}
  keyurl=${OMV_PROXMOX_KEY_REPOSITORY_URL:-"https://enterprise.proxmox.com/debian/proxmox-archive-keyring-${distro}.gpg"}
  repo="pve-no-subscription"
  
  # delete old .list file
  rm -fv "${pve}"
  
  # add repo sources file
  echo "Add new proxmox sources file ..."
  cat > "${pverepo}" << EOF
Types: deb
URIs: ${repourl}
Suites: ${distro}
Components: ${repo}
Signed-By: ${pvekey}
EOF
  
  echo "Download new proxmox key ..."
  wget --quiet --output-document=- "${keyurl}" | gpg --dearmor > "${pvekey}"
  chmod 644 ${pverepo} ${pvekey}
fi

if [ -f "${raspi}" ]; then
  echo "Fixing Raspberry Pi repo ..."
  sed -i "s/bookworm/trixie/g" ${raspi}
fi

exit 0
